"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[99193],{3905:(e,n,a)=>{a.d(n,{Zo:()=>c,kt:()=>m});var t=a(67294);function l(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function o(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function s(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?o(Object(a),!0).forEach((function(n){l(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function i(e,n){if(null==e)return{};var a,t,l=function(e,n){if(null==e)return{};var a,t,l={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||(l[a]=e[a]);return l}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var d=t.createContext({}),p=function(e){var n=t.useContext(d),a=n;return e&&(a="function"==typeof e?e(n):s(s({},n),e)),a},c=function(e){var n=p(e.components);return t.createElement(d.Provider,{value:n},e.children)},r={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},u=t.forwardRef((function(e,n){var a=e.components,l=e.mdxType,o=e.originalType,d=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(a),m=l,k=u["".concat(d,".").concat(m)]||u[m]||r[m]||o;return a?t.createElement(k,s(s({ref:n},c),{},{components:a})):t.createElement(k,s({ref:n},c))}));function m(e,n){var a=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var o=a.length,s=new Array(o);s[0]=u;var i={};for(var d in n)hasOwnProperty.call(n,d)&&(i[d]=n[d]);i.originalType=e,i.mdxType="string"==typeof e?e:l,s[1]=i;for(var p=2;p<o;p++)s[p]=a[p];return t.createElement.apply(null,s)}return t.createElement.apply(null,a)}u.displayName="MDXCreateElement"},58682:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>r,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var t=a(87462),l=(a(67294),a(3905));const o={sidebar_position:1},s="CollaSet",i={unversionedId:"manuals/collaset",id:"manuals/collaset",title:"CollaSet",description:"CollaSet is responsible for managing a set of Pods. Similar to Kubernetes Deployment and StatefulSet, it also supports scaling and updating Pods. Additionally, CollaSet offers advanced features to provide users with more granular control over managing Pods.",source:"@site/docs/operating/manuals/collaset.md",sourceDirName:"manuals",slug:"/manuals/collaset",permalink:"/operating/next/manuals/collaset",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"operating",previous:{title:"PodOpsLifecycle",permalink:"/operating/next/concepts/podopslifecycle"},next:{title:"ResourceConsist",permalink:"/operating/next/manuals/resourceconsist"}},d={},p=[{value:"Basic Features",id:"basic-features",level:2},{value:"Scaling Pods",id:"scaling-pods",level:3},{value:"Updating Pods",id:"updating-pods",level:3},{value:"Partition",id:"partition",level:4},{value:"Update by Label",id:"update-by-label",level:4},{value:"Advanced Features",id:"advanced-features",level:2},{value:"Pod Instance ID",id:"pod-instance-id",level:3},{value:"Revision Consistency",id:"revision-consistency",level:3},{value:"In-Place Update Pod",id:"in-place-update-pod",level:3},{value:"Replace Update Pod",id:"replace-update-pod",level:3},{value:"Recreate And Replace Specified Pod",id:"recreate-and-replace-specified-pod",level:3},{value:"Supprting PVCs",id:"supprting-pvcs",level:3},{value:"Provision PVCs",id:"provision-pvcs",level:4},{value:"Update PVCs",id:"update-pvcs",level:4},{value:"Add PVCs",id:"add-pvcs",level:4},{value:"Delete PVCs",id:"delete-pvcs",level:4},{value:"PVC Retention Policy",id:"pvc-retention-policy",level:4},{value:"whenScaled",id:"whenscaled",level:4},{value:"whenDelete",id:"whendelete",level:4}],c={toc:p};function r(e){let{components:n,...a}=e;return(0,l.kt)("wrapper",(0,t.Z)({},c,a,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"collaset"},"CollaSet"),(0,l.kt)("p",null,"CollaSet is responsible for managing a set of Pods. Similar to Kubernetes Deployment and StatefulSet, it also supports scaling and updating Pods. Additionally, CollaSet offers advanced features to provide users with more granular control over managing Pods."),(0,l.kt)("p",null,"A basic CollaSet configuration is represented in the following YAML format:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: foo\n  template:\n    metadata:\n      labels:\n        app: foo\n    spec:\n      containers:\n        - image: nginx:1.25.2\n          name: nginx\n")),(0,l.kt)("p",null,"Let's explore the features of CollaSet."),(0,l.kt)("h2",{id:"basic-features"},"Basic Features"),(0,l.kt)("h3",{id:"scaling-pods"},"Scaling Pods"),(0,l.kt)("p",null,"CollaSet utilizes the field spec.replicas to indicate the number of Pods under management."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  replicas: 3 # indicate the number of Pods to manage\n  selector:\n    matchLabels:\n      app: foo\n  template:\n    metadata:\n      labels:\n        app: foo\n    spec:\n      containers:\n        - image: nginx:1.25.2\n          name: nginx\n...\n")),(0,l.kt)("p",null,"Pods can be provisioned by CollaSet."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default apply -f ./config/samples/apps_v1alpha1_collaset.yaml\ncollaset.apps.kusionstack.io/collaset-sample created\n\n$ kubectl -n default get pod\nNAME                    READY   STATUS    RESTARTS   AGE\ncollaset-sample-85q7g   1/1     Running   0          57s\ncollaset-sample-vx5ws   1/1     Running   0          57s\ncollaset-sample-hr7pv   1/1     Running   0          57s\n\n$ kubectl -n default get cls\nNAME              DESIRED   CURRENT   UPDATED   UPDATED_READY   UPDATED_AVAILABLE   CURRENT_REVISION            UPDATED_REVISION            AGE\ncollaset-sample   3         3         3         3               3                   collaset-sample-6d7b7c58f   collaset-sample-6d7b7c58f   64s\n")),(0,l.kt)("p",null,"By default, CollaSet always creates new Pods using the latest template specified in ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.template"),". CollaSet establishes ownership over a set of Pods through the label selector defined in ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.selector"),". Thus, it's important to ensure that the labels provided in ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.selector")," match those in ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.template.metadata.labels"),"."),(0,l.kt)("p",null,"CollaSet status provides general information about this CollaSet and all Pods under it."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default get cls collaset-sample -o yaml\n......\nstatus:\n  availableReplicas: 3\n  collisionCount: 0\n  conditions:\n  - lastTransitionTime: "2023-09-01T03:56:09Z"\n    reason: Updated\n    status: "True"\n    type: Update\n  currentRevision: collaset-sample-6d7b7c58f\n  observedGeneration: 1\n  operatingReplicas: 0\n  readyReplicas: 3\n  replicas: 3\n  scheduledReplicas: 3\n  updatedAvailableReplicas: 3\n  updatedReadyReplicas: 3\n  updatedReplicas: 3\n  updatedRevision: collaset-sample-6d7b7c58f\n')),(0,l.kt)("p",null,"Some fields in CollaSet status are explained here:"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"updatedRevision")," indicates the latest revision that CollaSet uses to create or update Pods."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"currentRevision")," indicates the last updated revision. It will be set to updatedRevision after all Pods are updated, and their PodReady conditions become True."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"replicas")," indicates the count of Pods under this CollaSet."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"scheduledReplicas")," indicates the count of Pods under this CollaSet that successfully got scheduled."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"availableReplicas")," indicates the count of Pods under this CollaSet that have all expected finalizers attached."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"updatedReplicas")," indicates the count of Pods under this CollaSet that have the updated revision."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"updatedReadyReplicas")," indicates the count of Pods under this CollaSet that are counted in ",(0,l.kt)("inlineCode",{parentName:"p"},"updatedReplicas")," and have their PodReady conditions set to True."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"updatedAvailableReplicas")," indicates the count of Pods under this CollaSet that is counted in ",(0,l.kt)("inlineCode",{parentName:"p"},"updatedReadyReplicas")," and have all expected finalizers attached."),(0,l.kt)("h3",{id:"updating-pods"},"Updating Pods"),(0,l.kt)("p",null,"CollaSet generates Pods according to the pod template described in ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.template"),". This template can be updated to signal CollaSet to update each owned Pod:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls collaset-sample\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n......\nspec:\n......\n  template:\n    ......\n    spec:\n      containers:\n      - image: nginx:1.24.0  # changed from nginx:1.25.2 \n......\n")),(0,l.kt)("p",null,"CollaSet immediately updates all Pods it owns with the new Pod template by default."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default get pod -o yaml | grep "image: nginx"\n    - image: nginx:1.24.0\n    - image: nginx:1.24.0\n    - image: nginx:1.24.0\n')),(0,l.kt)("p",null,"The update progress can be controlled using partition."),(0,l.kt)("h4",{id:"partition"},"Partition"),(0,l.kt)("p",null,"Similar to StatefulSet, ",(0,l.kt)("inlineCode",{parentName:"p"},"partition")," is used to control the upgrade progress."),(0,l.kt)("p",null,"By default, if not indicated, all Pods will be updated when spec.template changes. The ",(0,l.kt)("inlineCode",{parentName:"p"},"partition")," can be adjusted from 0 to ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.replicas")," to specify how many Pods CollaSet should update. ",(0,l.kt)("strong",{parentName:"p"},"Unlike StatefulSet, the partition in CollaSet represents the number of Pods to update.")),(0,l.kt)("p",null,"Let's update the image back to nginx:1.25.2:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls collaset-sample\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  template:\n    ......\n    spec:\n      containers:\n      - image: nginx:1.25.2  # changed from nginx:1.24.0 \n  ...\n  updateStrategy:\n    rollingUpdate:\n      byPartition:\n        partition: 1    # use partition to control upgrade progress\n")),(0,l.kt)("p",null,"In this case, CollaSet only updates 1 Pod to the updated revision."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default get pod -o yaml | grep "image: nginx"\n    - image: nginx:1.24.0\n    - image: nginx:1.25.2   # only 1 Pod updated\n    - image: nginx:1.24.0\n')),(0,l.kt)("h4",{id:"update-by-label"},"Update by Label"),(0,l.kt)("p",null,"By configuring the ",(0,l.kt)("inlineCode",{parentName:"p"},"byLabel")," rolling update policy, users can precisely specify which Pods they want to update by using labels."),(0,l.kt)("p",null,"If you go back to the sample in the ",(0,l.kt)("a",{parentName:"p",href:"#Partition"},"section Partition")," and change ",(0,l.kt)("inlineCode",{parentName:"p"},"byPartition")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"byLabel")," like the following:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls collaset-sample\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  ...\n  updateStrategy:\n    rollingUpdate:\n-     byPartition:\n-       partition: 1\n+     byLabel: {}\n")),(0,l.kt)("p",null,"Subsequently, each Pod will only be updated if it's marked with the label ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset.kusionstack.io/update-included"),"."),(0,l.kt)("h2",{id:"advanced-features"},"Advanced Features"),(0,l.kt)("h3",{id:"pod-instance-id"},"Pod Instance ID"),(0,l.kt)("p",null,"Each Pod created by CollaSet has a unique ID held by the label ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset.kusionstack.io/instance-id"),", which can be used to identify each individual Pod."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    collaset.kusionstack.io/instance-id: "0"  # Pod instance ID\n...\n')),(0,l.kt)("p",null,"CollaSet provides a context to specify an ID pool, which defaults to the same name as the CollaSet and is immutable."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"...\nspec:\n  scaleStrategy:\n    context: <id-pool-name>\n")),(0,l.kt)("p",null,"The same ID pool name can be indicated for multiple CollaSets, allowing them to share a single ID pool. Consequently, each Pod created by these CollaSets will be assigned a unique ID."),(0,l.kt)("p",null,"For example, these are two CollaSets with the same context:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cat ~/sample.yaml\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample-a\nspec:\n  replicas: 2\n  scaleStrategy:\n    context: foo    # with the same context foo\n  selector:\n    matchLabels:\n      app: foo\n  template:\n    metadata:\n      labels:\n        app: foo\n    spec:\n      containers:\n        - image: nginx:1.25.2\n          name: nginx\n---\n\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample-b\nspec:\n  replicas: 2\n  scaleStrategy:\n    context: foo    # with the same context foo\n  selector:\n    matchLabels:\n      app: foo\n  template:\n    metadata:\n      labels:\n        app: foo\n    spec:\n      containers:\n        - image: nginx:1.25.2\n          name: nginx\n")),(0,l.kt)("p",null,"Then create these CollaSets with the sample file:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default apply -f ~/sample.yaml\ncollaset.apps.kusionstack.io/collaset-sample-a created\ncollaset.apps.kusionstack.io/collaset-sample-b created\n\n$ kubectl -n default get pod\nNAME                      READY   STATUS    RESTARTS   AGE\ncollaset-sample-a-g4sjj   1/1     Running   0          42s\ncollaset-sample-a-ph9vc   1/1     Running   0          42s\ncollaset-sample-b-fqkq4   1/1     Running   0          42s\ncollaset-sample-b-lqg8f   1/1     Running   0          42s\n\n$ kubectl -n default get pod -o yaml | grep collaset.kusionstack.io/instance-id\n      collaset.kusionstack.io/instance-id: "0"\n      collaset.kusionstack.io/instance-id: "1"\n      collaset.kusionstack.io/instance-id: "3"\n      collaset.kusionstack.io/instance-id: "2"\n')),(0,l.kt)("p",null,"Now, the 4 Pods created by these 2 CollaSets will have a unique instance ID."),(0,l.kt)("h3",{id:"revision-consistency"},"Revision Consistency"),(0,l.kt)("p",null,"Pods within a CollaSet can utilize more than two different Pod templates simultaneously, including both the current and updated revisions. This can result from partial updates. To ensure the stability of Pod revisions over time, CollaSet records this information. When a Pod is deleted, CollaSet recreates it using its previous revision."),(0,l.kt)("p",null,"It can be reproduced by following steps:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Provision a new CollaSet with replicas 3.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default apply -f ./config/samples/apps_v1alpha1_collaset.yaml\ncollaset.apps.kusionstack.io/collaset-sample created\n\n$ kubectl get pod\nNAME                     READY   STATUS    RESTARTS   AGE\ncollaset-sample-5tgcs    1/1     Running   0          4s\ncollaset-sample-glgnb    1/1     Running   0          4s\ncollaset-sample-qs46r    1/1     Running   0          4s\n\n$ kubectl -n default get cls\nNAME              DESIRED   CURRENT   UPDATED   UPDATED_READY   UPDATED_AVAILABLE   CURRENT_REVISION            UPDATED_REVISION            AGE\ncollaset-sample   3         3         3         3               3                   collaset-sample-6d7b7c58f   collaset-sample-6d7b7c58f   64s\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Update the image of PodTemplate of the CollaSet to image nginx:1.24.0 and set the partition to 2. Then there will be 2 Pods with image nginx:1.24.0 and 1 Pod with image nginx:1.25.2.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls collaset-sample\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  template:\n    ......\n    spec:\n      containers:\n      - image: nginx:1.24.0  # changed from nginx:1.25.2 \n  ...\n  updateStrategy:\n    rollingUpdate:\n      byPartition:\n        partition: 2    # update 2 Pods\n\n# Wait until these 2 Pods are updated, and check the Pod\'s images.\n$ kubectl get pod -o yaml | grep "image: nginx"\n    - image: nginx:1.25.2\n    - image: nginx:1.24.0\n    - image: nginx:1.24.0\n')),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"Update the image of PodTemplate of the CollaSet to image nginx:1.23.4 and set the partition to 1.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls collaset-sample\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  template:\n    ......\n    spec:\n      containers:\n      - image: nginx:1.23.4  # changed from nginx:1.24.0\n  ...\n  updateStrategy:\n    rollingUpdate:\n      byPartition:\n        partition: 1    # update 1 Pod\n\n# Wait until the Pod is updated, and check the Pod\'s images.\n$ kubectl get pod -o yaml | grep "image: nginx"\n    - image: nginx:1.25.2\n    - image: nginx:1.24.0   # Pod collaset-sample-qs46r\n    - image: nginx:1.23.4\n')),(0,l.kt)("p",null,"Now, there are 3 Pods, each of which has an individual image. If we then delete the Pod with the image nginx:1.24.0, the new Pod replacing it will be created with the same image nginx:1.24.0 in order for the Pod to inherit the revision."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl delete -n default delete pod collaset-sample-qs46r\npod "collaset-sample-qs46r" deleted\n\n$ kubectl get pod\nNAME                     READY   STATUS    RESTARTS      AGE\ncollaset-sample-5tgcs    1/1     Running   0             3h\ncollaset-sample-ht9x6    1/1     Running   0             2m27s  # Pod recreated\ncollaset-sample-qs46r    1/1     Running   1 (3h ago)    3h\n\n$ kubectl get pod -o yaml | grep "image: nginx"\n    - image: nginx:1.25.2\n    - image: nginx:1.24.0   # image has not been changed\n    - image: nginx:1.23.4\n')),(0,l.kt)("h3",{id:"in-place-update-pod"},"In-Place Update Pod"),(0,l.kt)("p",null,"In addition to the ",(0,l.kt)("inlineCode",{parentName:"p"},"Recreate")," update policy, which is identical to Deployment and StatefulSet, CollaSet offers the ",(0,l.kt)("inlineCode",{parentName:"p"},"InPlaceIfPossible")," update policy."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  ...\n  updateStrategy:\n    podUpgradePolicy: InPlaceIfPossible  # Options: InPlaceIfPossible, Recreate, Replace\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"InPlaceIfPossible")," is the default value, which instructs CollaSets to try to update Pods in place when only container images, labels, and annotations have changed. If some other fields have changed too, the policy will back off to the ",(0,l.kt)("inlineCode",{parentName:"p"},"Recreate")," policy."),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"Recreate")," indicates CollaSets always delete the old Pod and create a new one with an updated revision."),(0,l.kt)("p",null,"If update pod template with ",(0,l.kt)("inlineCode",{parentName:"p"},"InPlaceIfPossible")," policy as following example, the Pod will not be recreated."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls collaset-sample\napiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  template:\n    ......\n    spec:\n      containers:\n      - image: nginx:1.24.0  # changed from nginx:1.25.2\n  ...\n  updateStrategy:\n    podUpgradePolicy: InPlaceIfPossible # use InPlaceIfPossible policy\n\n$ kubectl -n default get pod -o yaml | grep "image: nginx"\n    - image: nginx:1.24.0\n    - image: nginx:1.24.0\n    - image: nginx:1.24.0\n\n$ kubectl -n default get pod\nNAME                     READY   STATUS    RESTARTS     AGE\ncollaset-sample-5wvlh    1/1     Running   1 (6s ago)   2m10s\ncollaset-sample-ldvrg    1/1     Running   1 (6s ago)   2m10s\ncollaset-sample-pbz75    1/1     Running   1 (6s ago)   2m10s\n')),(0,l.kt)("h3",{id:"replace-update-pod"},"Replace Update Pod"),(0,l.kt)("p",null,"CollaSet provides the ",(0,l.kt)("inlineCode",{parentName:"p"},"Replace")," policy for certain applications that are sensitive to the available number of Pods."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: collaset-sample\nspec:\n  ...\n  updateStrategy:\n    podUpgradePolicy: Replace  # Options: InPlaceIfPossible, Recreate, Replace\n")),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"Replace")," policy indicates that CollaSet should update a Pod by creating a new one to replace it.\nUnlike the ",(0,l.kt)("inlineCode",{parentName:"p"},"Recreate")," policy, which deletes the old Pod before creating a new updated one, or the ",(0,l.kt)("inlineCode",{parentName:"p"},"InPlaceIfPossible")," policy, which updates the current Pod in place,\nthe ",(0,l.kt)("inlineCode",{parentName:"p"},"Replace")," policy first creates a new Pod with the updated revision. It then deletes the old Pod once the new one becomes available for service."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"# Before updating CollaSet\n$ kubectl -n default get pod\nNAME                    READY   STATUS        RESTARTS   AGE\ncollaset-sample-dwkls   1/1     Running       0          6m55s\n\n# After updating CollaSet, the updated Pod is created first\n$ kubectl -n default get pod\nNAME                    READY   STATUS              RESTARTS   AGE\ncollaset-sample-dwkls   1/1     Running             0          6m55s\ncollaset-sample-rcmbv   0/1     ContainerCreating   0          0s\n\n# Once the created Pod is available for service, the old Pod will be deleted\n$ kubectl -n default get pod\nNAME                    READY   STATUS              RESTARTS   AGE\ncollaset-sample-rcmbv   1/1     Running             0          1s\ncollaset-sample-dwkls   1/1     Terminating         0          7m12s\n")),(0,l.kt)("p",null,"The two Pods will have a pair of labels to identify their relationship. The new Pod will have the label ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset.kusionstack.io/replace-pair-origin-name")," to indicate the name of the old Pod, and the old Pod will have the label ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset.kusionstack.io/replace-pair-new-id")," to indicate the instance ID of the new Pod."),(0,l.kt)("p",null,"Additionally, the new Pod and old Pod will each begin their own PodOpsLifecycles, which are independent of each other."),(0,l.kt)("h3",{id:"recreate-and-replace-specified-pod"},"Recreate And Replace Specified Pod"),(0,l.kt)("p",null,"In practice, users often need to recreate or replace specified Pods under a CollaSet."),(0,l.kt)("p",null,"To delete a Pod, users can simply call the Kubernetes API, like executing ",(0,l.kt)("inlineCode",{parentName:"p"},"kubectl delete pod <pod-name>"),".\nHowever, this will bypass the ",(0,l.kt)("a",{parentName:"p",href:"https://www.kusionstack.io/docs/operating/concepts/podopslifecycle"},"PodOpsLifecycle")," Mechanism.\nWe provide following two options:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Enable the feature ",(0,l.kt)("inlineCode",{parentName:"li"},"GraceDeleteWebhook")," so that it is possible to delete Pods through ",(0,l.kt)("inlineCode",{parentName:"li"},"PodOpsLifecycle"),".")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"# Enable the GraceDeleteWebhook feature when starting the controller with this argument\n$ /manager --feature-gates=GraceDeleteWebhook=true\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default get pod\nNAME                    READY   STATUS        RESTARTS   AGE\ncollaset-sample-vqccr   1/1     Running       0          21s\n\n# Delete the pod directly. A message will respond indicating that the Pod deletion is handled by PodOpsLifecycle\nkubectl -n default delete pod collaset-sample-vqccr\nError from server (failed to validate GraceDeleteWebhook, pod deletion process is underway and being managed by PodOpsLifecycle): admission webhook "validating-pod.apps.kusionstack.io" denied the request: failed to validate GraceDeleteWebhook, pod deletion process is underway and being managed by PodOpsLifecycle\n\n# The old Pod is deleted, and a new Pod will be created \n$ kubectl -n default get pod -w\ncollaset-sample-vqccr   1/1     Running       0          71s\ncollaset-sample-vqccr   1/1     Terminating   0          71s\n......\ncollaset-sample-nbl6t   0/1     Pending       0          0s\ncollaset-sample-nbl6t   0/1     ContainerCreating   0          0s\n......\ncollaset-sample-nbl6t   1/1     Running             0          0s\n')),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Label the Pod with ",(0,l.kt)("inlineCode",{parentName:"li"},"podopslifecycle.kusionstack.io/to-delete"),", so that CollaSet will delete the Pod through PodOpsLifecycle.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"# Label Pod\n$ kubectl -n default label pod collaset-sample-nbl6t podopslifecycle.kusionstack.io/to-delete=true\n\n# The old Pod is deleted, and a new Pod will be recreated \n$ kubectl -n default get pod -w\ncollaset-sample-nbl6t   1/1     Running       0          5m28s\ncollaset-sample-nbl6t   1/1     Terminating   0          5m28s\n......\ncollaset-sample-w6x69   0/1     Pending       0          0s\n......\ncollaset-sample-w6x69   0/1     ContainerCreating   0          0s\n......\ncollaset-sample-w6x69   1/1     Running             0          2s\n")),(0,l.kt)("p",null,"Recreating a Pod will delete the old Pod first and then create a new one. This will affect the available Pod count.\nTo avoid this, CollaSet provides a feature to replace Pods by labeling them with ",(0,l.kt)("inlineCode",{parentName:"p"},"podopslifecycle.kusionstack.io/to-replace"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"# Replace Pod by label\n$ kubectl -n echo label pod collaset-sample-w6x69 podopslifecycle.kusionstack.io/to-replace=true\n\n# The old Pod is deleted, and a new Pod will be created \n$ kubectl -n default get pod -w\ncollaset-sample-w6x69   1/1     Running       0          5m29s\ncollaset-sample-74fsv   0/1     Pending       0          0s\ncollaset-sample-74fsv   0/1     ContainerCreating   0          0s\n......\ncollaset-sample-74fsv   1/1     Running             0          2s\n......\ncollaset-sample-w6x69   0/1     Terminating         0          5m33s\n")),(0,l.kt)("h3",{id:"supprting-pvcs"},"Supprting PVCs"),(0,l.kt)("p",null,"CollaSet introduces support for PVCs, allowing user to declare ",(0,l.kt)("inlineCode",{parentName:"p"},"VolumeClaimTemplates")," to create PVCs for each Pod.\nFurthermore, in response to common issues with PVCs management, such as high modification costs and difficult control, CollaSet extends its functionality with the following advantages vs. StatefulSet:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Support update, add and delete on ",(0,l.kt)("inlineCode",{parentName:"li"},"volumeClaimTemplates"),"."),(0,l.kt)("li",{parentName:"ol"},"Provide control over PVC lifecycle.")),(0,l.kt)("h4",{id:"provision-pvcs"},"Provision PVCs"),(0,l.kt)("p",null,"The ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset-pvc.yaml")," file declares a CollaSet with ",(0,l.kt)("inlineCode",{parentName:"p"},"VolumeClaimTemplates")," to provision a PVC with ",(0,l.kt)("inlineCode",{parentName:"p"},"1Gi")," storage for each Pod.\nThese PVCs are then mounted on the container at the path ",(0,l.kt)("inlineCode",{parentName:"p"},"/path/mount/www"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: apps.kusionstack.io/v1alpha1\nkind: CollaSet\nmetadata:\n  name: foo\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: foo\n  template:\n    metadata:\n      labels:\n        app: foo\n    spec:\n      containers:\n      - image: nginx:1.25\n        name: nginx\n        volumeMounts: \n        - mountPath: /path/mount/www # path to mount PVC \n          name: www\n  volumeClaimTemplates:\n  - metadata:\n      name: www\n    spec:\n      storageClassName: standard\n      volumeMode: Filesystem\n      accessModes: [ "ReadWriteOnce" ]\n      resources:\n        requests:\n          storage: 1Gi\n')),(0,l.kt)("p",null,"Pods and PVCs can be provisioned by CollaSet."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default apply -f collaset-pvc.yaml\ncollaset.apps.kusionstack.io/foo created\n\n$ kubectl -n default get pod\nNAME        READY   STATUS    RESTARTS   AGE\nfoo-pw5lg   1/1     Running   0          4s\nfoo-5n6ts   1/1     Running   0          4s\n\n$ kubectl -n default get pvc\nNAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-h5zv7   Bound    pvc-8a7d8ea0-ced0-423a-9255-bedfad0f2db6   1Gi        RWO            standard       7s\nfoo-www-lswp2   Bound    pvc-9564b44b-9c99-467b-abee-4285183ff9c3   1Gi        RWO            standard       7s\n")),(0,l.kt)("p",null,"Each Pod and its related PVC have the same value of label ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset.kusionstack.io/instance-id"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default get pod -o yaml | grep instance-id\n      collaset.kusionstack.io/instance-id: "1"\n      collaset.kusionstack.io/instance-id: "0"\n\n$ kubectl -n default get pvc -o yaml | grep instance-id\n      collaset.kusionstack.io/instance-id: "1"\n      collaset.kusionstack.io/instance-id: "0"\n')),(0,l.kt)("h4",{id:"update-pvcs"},"Update PVCs"),(0,l.kt)("p",null,"To save the operating costs of PVCs, i.e. expand storage capacity, CollaSet supports update, add and delete on ",(0,l.kt)("inlineCode",{parentName:"p"},"volumeClaimTemplates"),"."),(0,l.kt)("p",null,"To achieve this, for each PVC, CollaSet calculates a hash value based on its template, and attatch it to label ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset.kusionstack.io/pvc-template-hash"),".\nOnce users modify the templates, CollaSet recognizes, caculates a new hash value and attach it on new PVCs to replace old ones."),(0,l.kt)("p",null,"Let's give it a try, update the storage of PVC template from ",(0,l.kt)("inlineCode",{parentName:"p"},"1Gi")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"2Gi"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls foo\n ......\n volumeClaimTemplates:\n - metadata:\n     name: www\n   spec:\n     storageClassName: standard\n     volumeModes: Filesystem\n     accessModes: [ "ReadWriteOnce" ]\n     resources:\n       requests:\n-        storage: 1Gi\n+        storage: 2Gi # update pvc template to expand storage\n......\n')),(0,l.kt)("p",null,"There are 2 new PVCs with ",(0,l.kt)("inlineCode",{parentName:"p"},"2Gi")," storage created with different hash values."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls foo\ncollaset.apps.kusionstack.io/foo edited\n\n$ kubectl -n default get pod\nNAME        READY   STATUS        RESTARTS   AGE\nfoo-pw5lg   1/1     Terminating   0          7s\nfoo-5n6ts   1/1     Terminating   0          7s\nfoo-9nhz4   0/1     Pending       0          1s\nfoo-xb2gd   0/1     Pending       0          1s\n\n$ kubectl -n default get pvc\nNAME            STATUS        VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-h5zv7   Terminating   pvc-8a7d8ea0-ced0-423a-9255-bedfad0f2db6   1Gi        RWO            standard       11s\nfoo-www-lswp2   Terminating   pvc-9564b44b-9c99-467b-abee-4285183ff9c3   1Gi        RWO            standard       11s\nfoo-www-cj2s9   Bound         pvc-647e2a81-7fc6-4f37-a835-e63da9172de3   2Gi        RWO            standard       5s\nfoo-www-hp2t6   Bound         pvc-03d7536e-cd3f-465f-bd30-362a9510f0c9   2Gi        RWO            standard       5s\n\n$ kubectl -n default get pvc -o yaml | grep pvc-template-hash\n      collaset.kusionstack.io/pvc-template-hash: 594d8857f9 # hash value of old pvc \n      collaset.kusionstack.io/pvc-template-hash: 594d8857f9\n      collaset.kusionstack.io/pvc-template-hash: d78c5ff6b # hash value of new pvc \n      collaset.kusionstack.io/pvc-template-hash: d78c5ff6b\n")),(0,l.kt)("p",null,"For old Pvcs, users can retain them by configuring ",(0,l.kt)("inlineCode",{parentName:"p"},"whenScaled")," policy to ",(0,l.kt)("inlineCode",{parentName:"p"},"Retain")," .\nThen old PVCs can be re-mount on its related Pod after rolling back.\nOtherwise, old PVCs can be deleted by default policy ",(0,l.kt)("inlineCode",{parentName:"p"},"Delete"),"."),(0,l.kt)("h4",{id:"add-pvcs"},"Add PVCs"),(0,l.kt)("p",null,"Add a PVC template ",(0,l.kt)("inlineCode",{parentName:"p"},"yyy"),", which is mounted on the container at the path ",(0,l.kt)("inlineCode",{parentName:"p"},"/path/mount/yyy"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls foo\n......\n    spec:\n      containers:\n      - image: nginx:1.25\n        name: nginx\n        volumeMounts: \n        - mountPath: /path/mount/www # path to mount PVC \n          name: www\n+       - mountPath: /path/mount/yyy # path to mount PVC \n+         name: yyy\n  volumeClaimTemplates:\n  - metadata:\n      name: www\n    spec:\n      storageClassName: standard\n      volumeMode: Filesystem\n      accessModes: [ "ReadWriteOnce" ]\n      resources:\n        requests:\n          storage: 2Gi\n+ - metadata: # added pvc template\n+     name: yyy \n+   spec:\n+     storageClassName: standard\n+     volumeMode: Filesystem\n+     accessModes: [ "ReadWriteOnce" ]\n+     resources:\n+       requests:\n+         storage: 2Gi\n')),(0,l.kt)("p",null,"Now, each pod has two PVCs, which include a new PVCs claimed by template ",(0,l.kt)("inlineCode",{parentName:"p"},"yyy")," and one old PVC claimed by template ",(0,l.kt)("inlineCode",{parentName:"p"},"www"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls foo\ncollaset.apps.kusionstack.io/foo edited\n\n$ kubectl -n default get pod\nNAME        READY   STATUS        RESTARTS   AGE\nfoo-8wwsz   0/1     Pending       0          1s\nfoo-9nhz4   1/1     Terminating   0          23s\nfoo-hd2cv   0/1     Pending       0          1s\nfoo-xb2gd   1/1     Terminating   0          23s\n\n$ kubectl -n default get pvc\nNAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-cj2s9   Bound    pvc-647e2a81-7fc6-4f37-a835-e63da9172de3   2Gi        RWO            standard       25s\nfoo-www-hp2t6   Bound    pvc-03d7536e-cd3f-465f-bd30-362a9510f0c9   2Gi        RWO            standard       25s\nfoo-yyy-c68nh   Bound    pvc-94ee5eff-2350-4cb7-8411-85f0928d25fc   2Gi        RWO            standard       3s # new pvc\nfoo-yyy-vpwss   Bound    pvc-8363dc78-3340-47d0-aa11-0adac36308d5   2Gi        RWO            standard       3s # new pvc\n")),(0,l.kt)("h4",{id:"delete-pvcs"},"Delete PVCs"),(0,l.kt)("p",null,"Delete the PVC template ",(0,l.kt)("inlineCode",{parentName:"p"},"yyy")," on CollaSet."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls foo\n......\n    spec:\n      containers:\n      - image: nginx:1.25\n        name: nginx\n        volumeMounts: \n        - mountPath: /path/mount/www # path to mount PVC \n          name: www\n-       - mountPath: /path/mount/yyy # path to mount PVC \n-         name: yyy\n  volumeClaimTemplates:\n  - metadata:\n      name: www\n    spec:\n      storageClassName: standard\n      volumeMode: Filesystem\n      accessModes: [ "ReadWriteOnce" ]\n      resources:\n        requests:\n          storage: 2Gi\n- - metadata: # delete pvc template\n-     name: yyy \n-   spec:\n-     storageClassName: standard\n-     volumeMode: Filesystem\n-     accessModes: [ "ReadWriteOnce" ]\n-     resources:\n-       requests:\n-         storage: 2Gi\n')),(0,l.kt)("p",null,"Now, PVCs claimed by template ",(0,l.kt)("inlineCode",{parentName:"p"},"yyy")," are deleted and the origin PVCs claimed by template ",(0,l.kt)("inlineCode",{parentName:"p"},"www")," are retained."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls foo\ncollaset.apps.kusionstack.io/foo edited\n\n$ kubectl -n default get pod\nNAME        READY   STATUS        RESTARTS   AGE\nfoo-6qcpc   1/1     Running       0          2s\nfoo-z2jqv   1/1     Running       0          2s\nfoo-8wwsz   1/1     Terminating   0          38s\nfoo-hd2cv   1/1     Terminating   0          38s\n\n$ kubectl -n default get pvc\nNAME            STATUS        VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-cj2s9   Bound         pvc-647e2a81-7fc6-4f37-a835-e63da9172de3   2Gi        RWO            standard       61s\nfoo-www-hp2t6   Bound         pvc-03d7536e-cd3f-465f-bd30-362a9510f0c9   2Gi        RWO            standard       61s\nfoo-yyy-c68nh   Terminating   pvc-94ee5eff-2350-4cb7-8411-85f0928d25fc   2Gi        RWO            standard       39s\nfoo-yyy-vpwss   Terminating   pvc-8363dc78-3340-47d0-aa11-0adac36308d5   2Gi        RWO            standard       39s\n")),(0,l.kt)("h4",{id:"pvc-retention-policy"},"PVC Retention Policy"),(0,l.kt)("p",null,"CollaSet provides control over PVC lifecycle by configuring ",(0,l.kt)("inlineCode",{parentName:"p"},"spec.persistentVolumeClaimRetentionPolicy"),".\nUsers can retain or delete PVCs after its related Pod is scaled down or CollaSet is deleted, respectively.\nThis feature is also supported by ",(0,l.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#persistentvolumeclaim-retention"},"StatefulSet")," since v1.27.\nBasic rule is detailed as follows:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"whenScale")," : decides to delete or retain PVCs after Pod is scaled down."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"whenDeleted"),": decides to delete or retain PVCs after CollaSet is deleted.")),(0,l.kt)("p",null,"For each policy users can set the value to either Delete (by default) or Retain.\nNote that for StatefulSet, the default policy is Retain."),(0,l.kt)("h4",{id:"whenscaled"},"whenScaled"),(0,l.kt)("p",null,"Apply ",(0,l.kt)("inlineCode",{parentName:"p"},"collaset-pvc.yaml")," and edit foo to scale replicas to 1."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl apply -f collaset-pvc.yaml\ncollaset.apps.kusionstack.io/foo created\n\n$ kubectl edit cls foo\n ......\n spec:\n-  replicas: 2\n+  replicas: 1 # scale in 1 pod\n   selector:\n     matchLabels:\n       app: foo\n ......\n")),(0,l.kt)("p",null,"As the ",(0,l.kt)("inlineCode",{parentName:"p"},"whenScaled")," is not configured, thus its value is ",(0,l.kt)("inlineCode",{parentName:"p"},"Delete")," by default.\nConsequently, PVC ",(0,l.kt)("inlineCode",{parentName:"p"},"foo-www-wzwbq")," is deleted as its related Pod ",(0,l.kt)("inlineCode",{parentName:"p"},"foo-tkc5m"),"  is scaling down."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls foo\ncollaset.apps.kusionstack.io/foo edited\n\n$ kubectl -n default get pod\nNAME        READY   STATUS    RESTARTS   AGE\nfoo-tkc5m   0/1     Terminating   0          27s # related pvc is terminating\nfoo-vwtcm   1/1     Running       0          27s\n\n$ kubectl -n default get pvc\nNAME            STATUS        VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-wzwbq   Terminating   pvc-b92c28c6-59ad-4976-810c-8d538c4a22c6   1Gi        RWO            standard       29s\nfoo-www-r4vlh   Bound         pvc-dd7f7cce-a3cb-4bba-a106-e5ad264959a2   1Gi        RWO            standard       29s\n")),(0,l.kt)("p",null,"Set ",(0,l.kt)("inlineCode",{parentName:"p"},"Retain")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"whenScaled"),", and scale replicas to 0."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls foo\n ......\n spec:\n-  replicas: 1\n+  replicas: 0 # scale in 1 pod\n   selector:\n     matchLabels:\n       app: foo\n+  scaleStrategy:\n+    persistentVolumeClaimRetentionPolicy:\n+      whenScaled: Retain # retain the pvc after pod is scaled down\n ......\n")),(0,l.kt)("p",null,"Pod ",(0,l.kt)("inlineCode",{parentName:"p"},"foo-vwtcm")," is terminating, while its related PVC ",(0,l.kt)("inlineCode",{parentName:"p"},"foo-www-r4vlh")," is retained."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls foo\ncollaset.apps.kusionstack.io/foo edited\n\n$ kubectl -n default get pod\nNAME        READY   STATUS        RESTARTS   AGE\nfoo-vwtcm -n default   1/1     Terminating   0          62s # related pvc is retained\n\n$ kubectl -n default get pvc\nNAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-r4vlh   Bound    pvc-dd7f7cce-a3cb-4bba-a106-e5ad264959a2   1Gi        RWO            standard       63s\n")),(0,l.kt)("p",null,"To validate the retention policy, try ro scale replicas to 2, and the remaining PVC should be mounted again."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl -n default edit cls foo\n ......\n spec:\n-  replicas: 0\n+  replicas: 2 # scale out 2 pods\n   ......\n")),(0,l.kt)("p",null,"We can see that PVC ",(0,l.kt)("inlineCode",{parentName:"p"},"foo-www-r4vlh")," is retained by Pod ",(0,l.kt)("inlineCode",{parentName:"p"},"foo-px487")," as they have the same ",(0,l.kt)("inlineCode",{parentName:"p"},"instance-id"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls foo\ncollaset.apps.kusionstack.io/foo edited\n\n$ kubectl -n default get pod\nNAME        READY   STATUS    RESTARTS   AGE\nfoo-ld5xc   1/1     Running   0          27s\nfoo-px487   1/1     Running   0          27s\n\n$ kubectl -n default get pvc\nNAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-d48gx   Bound    pvc-1884ee45-5cc9-48ee-b01a-20f5ad63d6d4   1Gi        RWO            standard       29s\nfoo-www-r4vlh   Bound    pvc-dd7f7cce-a3cb-4bba-a106-e5ad264959a2   1Gi        RWO            standard       2m47s\n\n$ kubectl -n default get pod foo-px487 -o yaml | grep instance-id\n      collaset.kusionstack.io/instance-id: "1"\n\n$ kubectl -n default get pvc foo-www-r4vlh -o yaml | grep instance-id\n      collaset.kusionstack.io/instance-id: "1" # pvc foo-www-r4vlh is retained\n')),(0,l.kt)("h4",{id:"whendelete"},"whenDelete"),(0,l.kt)("p",null,"Edit ",(0,l.kt)("inlineCode",{parentName:"p"},"foo")," to configure ",(0,l.kt)("inlineCode",{parentName:"p"},"Retain")," policy for ",(0,l.kt)("inlineCode",{parentName:"p"},"whenDelete"),", and then delete this CollaSet."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default edit cls foo\n   ......\n   scaleStrategy:\n     persistentVolumeClaimRetentionPolicy:\n       whenScaled: Retain\n+      whenDelete: Retain # retain the pvc after collaset is deleted\n   ......\ncollaset.apps.kusionstack.io/foo edited\n\n$ kubectl -n default delete cls foo\ncollaset.apps.kusionstack.io "foo" deleted\n')),(0,l.kt)("p",null,"Now, try to recreate ",(0,l.kt)("inlineCode",{parentName:"p"},"foo")," with 2 replicas, and the result shows both PVCs are retained."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n default apply -f collaset-pvc.yaml\ncollaset.apps.kusionstack.io/foo created\n\n$ kubectl -n default get pod\nNAME        READY   STATUS    RESTARTS   AGE\nfoo-qhh8t   1/1     Running   0          2s\nfoo-ss255   1/1     Running   0          2s\n\n$ kubectl -n default get pvc\nNAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nfoo-www-d48gx   Bound    pvc-1884ee45-5cc9-48ee-b01a-20f5ad63d6d4   1Gi        RWO            standard       4m29s\nfoo-www-r4vlh   Bound    pvc-dd7f7cce-a3cb-4bba-a106-e5ad264959a2   1Gi        RWO            standard       6m47s\n\n$ kubectl -n default get pod foo-px487 -o yaml | grep instance-id\n      collaset.kusionstack.io/instance-id: "0"\n      collaset.kusionstack.io/instance-id: "1"\n\n$ kubectl -n default get pvc foo-www-r4vlh -o yaml | grep instance-id\n      collaset.kusionstack.io/instance-id: "0" # pvc foo-www-d48gx is retained\n      collaset.kusionstack.io/instance-id: "1" # pvc foo-www-r4vlh is retained\n')))}r.isMDXComponent=!0}}]);